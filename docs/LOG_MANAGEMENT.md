# 日志管理和轮转策略

本文档提供了生产环境中日志文件管理和轮转的最佳实践建议，适用于通过Jenkins部署的招生系统应用。

## 日志存储位置

在生产环境中，日志文件存储在以下位置：

- **宿主机路径**: `/var/log/zhaosheng/`
- **容器内路径**: `/app/backend/logs/`
- **环境变量配置**: `LOG_DIR=/app/backend/logs`

## 日志目录结构

系统会自动创建以下日志目录结构：

```
/var/log/zhaosheng/
├── system/       # 系统日志
├── mongodb/      # MongoDB日志
├── redis/        # Redis日志
└── [日期命名的日志文件]  # 按日期分割的日志文件
```

## 日志轮转策略建议

为防止日志文件无限增长占用磁盘空间，建议配置日志轮转。以下是两种主要方案：

### 方案1：使用logrotate（推荐）

在生产服务器上配置logrotate来管理日志文件：

1. 创建logrotate配置文件：
   ```bash
   sudo nano /etc/logrotate.d/zhaosheng
   ```

2. 添加以下配置内容：
   ```
/var/log/zhaosheng/*.log {
       daily                   # 每天轮转一次
       rotate 14               # 保留14天的日志
       compress                # 压缩旧日志
       delaycompress           # 延迟压缩到下一次轮转
       missingok               # 忽略缺失的日志文件
       notifempty              # 空文件不轮转
       create 0644 node node   # 创建新文件的权限
       sharedscripts           # 所有匹配的文件只执行一次脚本
       postrotate
           # 可选：发送SIGHUP信号给应用（如果需要）
           # kill -HUP $(cat /var/run/zhaosheng.pid 2>/dev/null) 2>/dev/null || true
       endscript
   }
   ```

3. 保存并退出，logrotate会自动按计划运行。

### 方案2：代码级日志轮转

如果需要在应用代码中实现日志轮转，可以修改logger.js文件，添加文件大小限制和自动轮转功能。

## 日志权限管理

- 日志目录权限：`755`（所有者读写执行，其他用户读执行）
- 日志文件权限：`644`（所有者读写，其他用户只读）
- 文件所有者：容器内用户（UID 1000）

## 日志监控建议

1. **定期检查日志大小**：监控日志目录占用的磁盘空间
2. **设置告警阈值**：当日志目录大小超过预设阈值时发出告警
3. **日志分析工具**：考虑集成ELK（Elasticsearch, Logstash, Kibana）栈进行日志聚合和分析
4. **错误日志监控**：特别关注包含ERROR和FATAL级别的日志条目

## 日志保留策略

根据数据保留需求和磁盘空间限制，建议：

- **系统日志**：保留14-30天
- **数据库操作日志**：保留30-90天
- **业务关键日志**：可考虑长期归档（压缩存储）

## 安全注意事项

- 确保日志文件不包含敏感信息（如密码、令牌等）
- 定期审计日志访问权限
- 对于包含敏感信息的日志，考虑加密存储

## 日志备份建议

1. 配置定期将重要日志备份到外部存储
2. 实现增量备份策略，减少带宽和存储消耗
3. 测试恢复流程，确保备份有效

## 实施步骤

1. 部署前确保目标服务器上创建了`/var/log/zhaosheng`目录
2. 配置logrotate规则（推荐）
3. 设置定期日志审查流程
4. 监控日志存储使用情况

---

*本文档由Jenkins CI/CD流程自动生成和部署。*